generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DATABASE_URL_UNPOOLED")
}

enum Role {
  STUDENT
  TEACHER
}

enum AidKey {
  AID1
  AID2
  AI_ASSIST
}

enum AttemptStatus {
  IN_PROGRESS
  SUBMITTED
  EXPIRED
}

enum AttemptKind {
  GENERIC
  ENTRY
  TRAINING
  EXIT
}

enum Level {
  LOW
  MEDIUM
  HIGH
}

model User {
  id                 String   @id @default(uuid()) @map("id")
  email              String   @unique @map("email")
  passwordHash       String   @map("password_hash")
  acceptedTos        Boolean  @map("accepted_tos")
  role               Role     @default(STUDENT) @map("role")
  otpCode            String?  @map("otp_code")
  academicProgram    String?  @map("academic_program")
  onboardingComplete Boolean  @default(false) @map("onboarding_complete")
  fullName           String?  @map("full_name")
  profilePhoto       String?  @map("profile_photo")

  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  examAttempts       ExamAttempt[]
  placements         Placement[]

  @@map("users")
  @@index([email])
}

model Exam {
  id              String    @id @default(uuid()) @map("id")
  slug            String    @unique @map("slug")
  title           String    @map("title")
  description     String?   @map("description")
  durationMinutes Int       @default(90) @map("duration_minutes")
  version         Int       @default(1) @map("version")
  isActive        Boolean   @default(true) @map("is_active")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  questions      Question[]
  examAttempts   ExamAttempt[]
  categoryDefs   EntryCategoryDefinition[]
  placementRules PlacementRule[]

  @@map("exams")
  @@index([slug])
}

model Question {
  id            String   @id @default(uuid()) @map("id")
  examId        String   @map("exam_id")
  orderIndex    Int      @map("order_index")
  code          String?  @map("code")
  prompt        String   @map("prompt_md")
  competency    String?  @map("competency")
  evidence      String?  @map("evidence")
  contentArea   String?  @map("content_area")
  context       String?  @map("context")
  help1Md       String?  @map("help1_md")
  help2Md       String?  @map("help2_md")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  exam           Exam           @relation(fields: [examId], references: [id], onDelete: Cascade)
  choices        Option[]
  examResponses  ExamResponse[]
  aidUsages      ExamAidUsage[]
  planQuestions  PlanQuestion[]

  @@unique([examId, orderIndex])
  @@map("questions")
  @@index([examId])
}

model Option {
  id          String   @id @default(uuid()) @map("id")
  questionId  String   @map("question_id")
  label       String   @map("label")
  text        String?  @map("text")
  imageUrl    String?  @map("image_url")
  isCorrect   Boolean  @default(false) @map("is_correct")
  createdAt   DateTime @default(now()) @map("created_at")

  question       Question       @relation(fields: [questionId], references: [id], onDelete: Cascade)
  examResponses  ExamResponse[]

  @@unique([questionId, label])
  @@map("options")
  @@index([questionId])
}

model ExamAttempt {
  id            String        @id @default(uuid()) @map("id")
  userId        String        @map("user_id")
  examId        String        @map("exam_id")
  startedAt     DateTime      @default(now()) @map("started_at")
  submittedAt   DateTime?     @map("submitted_at")
  timeSpent     Int?          @map("time_spent")
  score         Float?        @map("score")
  status        AttemptStatus @default(IN_PROGRESS) @map("status")
  kind          AttemptKind   @default(GENERIC) @map("kind")
  trainingPlanId String?      @map("training_plan_id")
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  exam          Exam           @relation(fields: [examId], references: [id], onDelete: Cascade)
  trainingPlan  TrainingPlan?  @relation(fields: [trainingPlanId], references: [id], onDelete: SetNull)
  responses     ExamResponse[]
  aidUsages     ExamAidUsage[]
  categoryScores EntryCategoryScore[]
  placementsAsEntry Placement[]

  @@map("exam_attempts")
  @@index([userId])
  @@index([examId])
  @@index([status])
  @@index([kind])
  @@index([trainingPlanId])
}

model ExamResponse {
  id               String    @id @default(uuid()) @map("id")
  attemptId        String    @map("attempt_id")
  questionId       String    @map("question_id")
  selectedOptionId String?   @map("selected_option_id")
  answeredAt       DateTime  @default(now()) @map("answered_at")
  isCorrect        Boolean?  @map("is_correct")
  timeSpentMs      Int?      @map("time_spent_ms")
  usedAid1         Boolean   @default(false) @map("used_aid_1")
  usedAid2         Boolean   @default(false) @map("used_aid_2")
  usedAidAi        Boolean   @default(false) @map("used_aid_ai")
  createdAt        DateTime  @default(now()) @map("created_at")

  attempt        ExamAttempt @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  question       Question    @relation(fields: [questionId], references: [id], onDelete: Cascade)
  selectedOption Option?     @relation(fields: [selectedOptionId], references: [id], onDelete: SetNull)

  @@unique([attemptId, questionId])
  @@map("exam_responses")
  @@index([attemptId])
  @@index([questionId])
  @@index([selectedOptionId])
}

model ExamAidUsage {
  id         String   @id @default(uuid()) @map("id")
  attemptId  String   @map("attempt_id")
  questionId String   @map("question_id")
  aidKey     AidKey   @map("aid_key")
  createdAt  DateTime @default(now()) @map("created_at")

  attempt    ExamAttempt @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  question   Question    @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@unique([attemptId, questionId, aidKey])
  @@map("exam_aid_usages")
  @@index([attemptId])
  @@index([questionId])
}

/* ===== Planes de Entrenamiento, Reglas de colocación y Categorías ===== */

model TrainingPlan {
  id                        String         @id @default(uuid()) @map("id")
  code                      String         @unique @map("code") // "A"..."G"
  title                     String?        @map("title")
  description               String?        @map("description")
  minRequiredToUnlockExit   Int            @map("min_required_to_unlock_exit")
  isActive                  Boolean        @default(true) @map("is_active")
  createdAt                 DateTime       @default(now()) @map("created_at")
  updatedAt                 DateTime       @updatedAt @map("updated_at")

  placementRules PlacementRule[]
  placements     Placement[]

  planQuestions             PlanQuestion[]
  examAttempts              ExamAttempt[]

  @@map("training_plans")
  @@index([isActive])
}

model PlanQuestion {
  id             String        @id @default(uuid()) @map("id")
  trainingPlanId String        @map("training_plan_id")
  questionId     String        @map("question_id")
  orderIndex     Int?          @map("order_index")
  createdAt      DateTime      @default(now()) @map("created_at")

  trainingPlan   TrainingPlan  @relation(fields: [trainingPlanId], references: [id], onDelete: Cascade)
  question       Question      @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@unique([trainingPlanId, questionId])
  @@map("plan_questions")
  @@index([trainingPlanId])
  @@index([questionId])
}

model EntryCategoryDefinition {
  id            String   @id @default(uuid()) @map("id")
  examId        String   @map("exam_id") // examen de entrada/salida ("saberpro_exam")
  key           String   @map("key")     // "INTERPRETACION", "FORMULACION", "ARGUMENTACION"
  name          String   @map("name")
  orderStart    Int      @map("order_start") // rango por índice de orden
  orderEnd      Int      @map("order_end")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  exam          Exam     @relation(fields: [examId], references: [id], onDelete: Cascade)
  thresholds    EntryCategoryThreshold[]
  scores        EntryCategoryScore[]

  @@unique([examId, key])
  @@map("entry_category_definitions")
  @@index([examId])
}

model EntryCategoryThreshold {
  id                      String  @id @default(uuid()) @map("id")
  categoryDefinitionId    String  @map("category_definition_id")
  level                   Level   @map("level")
  minPointsInclusive      Int     @map("min_points_inclusive")
  maxPointsInclusive      Int     @map("max_points_inclusive")

  categoryDefinition      EntryCategoryDefinition @relation(fields: [categoryDefinitionId], references: [id], onDelete: Cascade)

  @@unique([categoryDefinitionId, level])
  @@map("entry_category_thresholds")
  @@index([categoryDefinitionId])
}

model EntryCategoryScore {
  id                      String    @id @default(uuid()) @map("id")
  attemptId               String    @map("attempt_id") // intento ENTRY
  categoryDefinitionId    String    @map("category_definition_id")
  rawPoints               Int       @map("raw_points")
  level                   Level     @map("level")
  createdAt               DateTime  @default(now()) @map("created_at")

  attempt                 ExamAttempt             @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  categoryDefinition      EntryCategoryDefinition @relation(fields: [categoryDefinitionId], references: [id], onDelete: Cascade)

  @@unique([attemptId, categoryDefinitionId])
  @@map("entry_category_scores")
  @@index([attemptId])
  @@index([categoryDefinitionId])
}

model PlacementRule {
  id            String   @id @default(uuid()) @map("id")
  examId        String   @map("exam_id") // examen de entrada/salida
  interpLevel   Level    @map("interp_level")
  formLevel     Level    @map("form_level")
  arguLevel     Level    @map("argu_level")
  trainingPlanId String  @map("training_plan_id")

  exam          Exam          @relation(fields: [examId], references: [id], onDelete: Cascade)
  trainingPlan  TrainingPlan  @relation(fields: [trainingPlanId], references: [id], onDelete: Cascade)

  @@unique([examId, interpLevel, formLevel, arguLevel])
  @@map("placement_rules")
  @@index([examId])
  @@index([trainingPlanId])
}

model Placement {
  id              String       @id @default(uuid()) @map("id")
  userId          String       @map("user_id")
  entryAttemptId  String       @map("entry_attempt_id")
  trainingPlanId  String       @map("training_plan_id")
  interpLevel     Level        @map("interp_level")
  formLevel       Level        @map("form_level")
  arguLevel       Level        @map("argu_level")
  createdAt       DateTime     @default(now()) @map("created_at")

  user            User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  entryAttempt    ExamAttempt  @relation(fields: [entryAttemptId], references: [id], onDelete: Cascade)
  trainingPlan    TrainingPlan @relation(fields: [trainingPlanId], references: [id], onDelete: Cascade)

  @@map("placements")
  @@index([userId])
  @@index([trainingPlanId])
  @@index([entryAttemptId])
}
